<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>280 Day Drawing Calendar — Date Remapper</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400&display=swap');
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0a0a0a; --surface: #111; --border: #222;
    --accent: #c8ff00; --accent2: #ff6b35; --text: #e8e8e8; --muted: #555;
  }
  body {
    background: var(--bg); color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh; display: flex; flex-direction: column;
    align-items: center; padding: 40px 20px;
  }
  .container { width: 100%; max-width: 640px; }
  .eyebrow { font-size: 10px; letter-spacing: .3em; color: var(--accent); text-transform: uppercase; margin-bottom: 8px; }
  h1 { font-family: 'Bebas Neue', sans-serif; font-size: clamp(48px,10vw,80px); line-height: .9; letter-spacing: .02em; margin-bottom: 12px; }
  h1 span { color: var(--accent); }
  .subtitle { font-size: 11px; color: var(--muted); letter-spacing: .1em; line-height: 1.9; margin-bottom: 40px; }
  .card { background: var(--surface); border: 1px solid var(--border); padding: 28px; margin-bottom: 14px; }
  .field-label { font-size: 10px; letter-spacing: .25em; color: var(--accent); text-transform: uppercase; margin-bottom: 12px; display: block; }
  .orig-bar { font-size: 12px; color: var(--muted); margin-bottom: 22px; padding-bottom: 22px; border-bottom: 1px solid var(--border); letter-spacing: .05em; }
  .orig-bar strong { color: var(--text); font-weight: 300; }
  input[type="file"] {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    color: var(--muted); font-family: 'DM Mono', monospace; font-size: 11px;
    padding: 14px 16px; cursor: pointer; letter-spacing: .05em; transition: border-color .2s;
  }
  input[type="file"]:hover { border-color: var(--accent); }
  input[type="date"] {
    width: 100%; background: var(--bg); border: 1px solid var(--border);
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 22px;
    padding: 14px 18px; outline: none; cursor: pointer; transition: border-color .2s; letter-spacing: .05em;
  }
  input[type="date"]:focus, input[type="date"]:hover { border-color: var(--accent); }
  input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1) sepia(1) saturate(5) hue-rotate(50deg); cursor: pointer; transform: scale(1.2);
  }
  .file-info { margin-top: 10px; font-size: 11px; color: var(--muted); letter-spacing: .08em; min-height: 16px; }
  .preview { margin-top: 18px; padding-top: 18px; border-top: 1px solid var(--border); font-size: 11px; color: var(--muted); letter-spacing: .08em; line-height: 2.4; display: none; }
  .preview .row { display: flex; justify-content: space-between; }
  .preview .val { color: var(--accent2); }
  .preview .val.good { color: var(--accent); }
  .btn {
    width: 100%; background: var(--accent); color: var(--bg);
    font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: .12em;
    padding: 18px; border: none; cursor: pointer; transition: all .15s; margin-top: 8px;
  }
  .btn:hover:not(:disabled) { background: #d9ff1a; transform: translateY(-1px); }
  .btn:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; }

  /* OUTPUT AREA */
  .output-box { display: none; margin-top: 16px; }
  .output-box .instructions {
    font-size: 11px; color: var(--muted); letter-spacing: .08em; line-height: 2;
    margin-bottom: 12px; padding: 16px; background: var(--surface); border: 1px solid var(--border);
  }
  .output-box .instructions strong { color: var(--accent); font-weight: 400; }
  .output-actions { display: flex; gap: 8px; }
  .btn-small {
    flex: 1; background: var(--surface); color: var(--text); border: 1px solid var(--accent);
    font-family: 'Bebas Neue', sans-serif; font-size: 16px; letter-spacing: .1em;
    padding: 12px; cursor: pointer; transition: all .15s;
  }
  .btn-small:hover { background: var(--accent); color: var(--bg); }
  .btn-small.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .btn-small.primary:hover { background: #d9ff1a; }
  .copy-status { font-size: 10px; color: var(--accent); letter-spacing: .1em; margin-top: 8px; min-height: 16px; text-align: center; }

  .divider { height: 1px; background: var(--border); margin: 28px 0; }
  .how-it-works { font-size: 10px; color: var(--muted); letter-spacing: .08em; line-height: 2.2; }
  .how-it-works li { list-style: none; }
  .how-it-works li::before { content: '→  '; color: var(--accent); }
  .tag { display: inline-block; background: #1a1a1a; border: 1px solid var(--border); font-size: 9px; padding: 3px 10px; letter-spacing: .15em; color: var(--muted); margin-top: 24px; }
</style>
</head>
<body>
<div class="container">
  <p class="eyebrow">Art Curriculum Tool</p>
  <h1>280 Day<br><span>Drawing</span><br>Calendar</h1>
  <p class="subtitle">Upload your ICS · pick a new start date · download remapped calendar</p>

  <div class="card">
    <label class="field-label" for="fileInput">Step 1 — Load Your ICS File</label>
    <input type="file" id="fileInput" accept=".ics">
    <div class="file-info" id="fileInfo"></div>
  </div>

  <div class="card">
    <div class="orig-bar" id="origBar">Original start date: <strong>load a file above</strong></div>
    <label class="field-label" for="newDate">Step 2 — Choose Your New Start Date</label>
    <input type="date" id="newDate">
    <div class="preview" id="preview">
      <div class="row"><span>Original start</span><span class="val" id="pOrig">—</span></div>
      <div class="row"><span>New start</span><span class="val good" id="pNew">—</span></div>
      <div class="row"><span>Day offset</span><span class="val" id="pOff">—</span></div>
      <div class="row"><span>Calendar ends</span><span class="val" id="pEnd">—</span></div>
    </div>
  </div>

  <button class="btn" id="generateBtn" disabled>↓ &nbsp;Generate Remapped Calendar</button>

  <!-- Output area shown after generation -->
  <div class="output-box" id="outputBox">
    <div class="instructions">
      <strong>Your calendar is ready.</strong><br>
      Click <strong>Download ICS</strong> — if it opens in the browser instead of downloading,
      right-click the link and choose <em>Save Link As</em>, then save as <code>.ics</code>.<br>
      Or click <strong>Copy ICS Text</strong>, paste into a text editor, and save as <code>calendar.ics</code>.
    </div>
    <div class="output-actions">
      <a class="btn-small primary" id="downloadLink" href="#" download="drawing_calendar.ics">↓ Download ICS</a>
      <button class="btn-small" id="copyBtn">⎘ Copy ICS Text</button>
    </div>
    <div class="copy-status" id="copyStatus"></div>
  </div>

  <div class="divider"></div>
  <ul class="how-it-works">
    <li>Upload your existing 280-day ICS file</li>
    <li>Pick any new start date — past or future</li>
    <li>All 280 events shift by the same number of days</li>
    <li>All content, notes, and alerts are preserved exactly</li>
    <li>Import into Apple Calendar, Google Calendar, or Outlook</li>
  </ul>
  <div class="tag">280 DAYS · ALL CONTENT PRESERVED · ALERTS INTACT</div>
</div>

<script>
  let icsText = null;
  let originalStart = null;
  let generatedICS = null;

  const fileInput   = document.getElementById('fileInput');
  const newDateEl   = document.getElementById('newDate');
  const generateBtn = document.getElementById('generateBtn');
  const outputBox   = document.getElementById('outputBox');
  const downloadLink = document.getElementById('downloadLink');
  const copyBtn     = document.getElementById('copyBtn');
  const copyStatus  = document.getElementById('copyStatus');
  const fileInfo    = document.getElementById('fileInfo');
  const origBar     = document.getElementById('origBar');
  const preview     = document.getElementById('preview');

  // Default to today
  newDateEl.value = new Date().toISOString().split('T')[0];

  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    fileInfo.style.color = 'var(--muted)';
    fileInfo.textContent = '⟳ Reading…';
    const reader = new FileReader();
    reader.onload = ev => {
      icsText = ev.target.result;
      originalStart = extractFirstDate(icsText);
      if (originalStart) {
        fileInfo.style.color = 'var(--accent)';
        fileInfo.textContent = `✓  ${file.name}  (${(file.size/1024).toFixed(1)} KB · ${countEvents(icsText)} events)`;
        origBar.innerHTML = `Original start date: <strong>${fmt(originalStart)}</strong>`;
        updatePreview();
        checkReady();
      } else {
        fileInfo.style.color = 'var(--accent2)';
        fileInfo.textContent = '✗ Could not parse dates. Is this an ICS file?';
      }
    };
    reader.readAsText(file);
  });

  newDateEl.addEventListener('change', () => { updatePreview(); checkReady(); resetOutput(); });
  newDateEl.addEventListener('input',  () => { updatePreview(); checkReady(); resetOutput(); });

  function resetOutput() {
    outputBox.style.display = 'none';
    generatedICS = null;
    copyStatus.textContent = '';
  }

  function extractFirstDate(text) {
    const re = /DTSTART(?:;TZID=[^:]+)?:(\d{8})/g;
    let m, earliest = null;
    while ((m = re.exec(text)) !== null) {
      const d = parseD(m[1]);
      if (!earliest || d < earliest) earliest = d;
    }
    return earliest;
  }

  function countEvents(text) {
    return (text.match(/^BEGIN:VEVENT/gm) || []).length;
  }

  function parseD(str) {
    return new Date(+str.slice(0,4), +str.slice(4,6)-1, +str.slice(6,8));
  }

  function fmtICS(d) {
    return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;
  }

  function pad(n) { return String(n).padStart(2,'0'); }

  function addDays(d, n) {
    const r = new Date(d); r.setDate(r.getDate()+n); return r;
  }

  function fmt(d) {
    return d.toLocaleDateString('en-US', { weekday:'short', year:'numeric', month:'short', day:'numeric' });
  }

  function getNewStart() {
    const [y,m,d] = newDateEl.value.split('-').map(Number);
    return new Date(y, m-1, d);
  }

  function updatePreview() {
    if (!originalStart || !newDateEl.value) return;
    const ns = getNewStart();
    const diff = Math.round((ns - originalStart) / 86400000);
    document.getElementById('pOrig').textContent = fmt(originalStart);
    document.getElementById('pNew').textContent  = fmt(ns);
    document.getElementById('pOff').textContent  = `${diff >= 0 ? '+' : ''}${diff} days`;
    document.getElementById('pEnd').textContent  = fmt(addDays(ns, 279));
    preview.style.display = 'block';
  }

  function checkReady() {
    generateBtn.disabled = !(icsText && originalStart && newDateEl.value);
  }

  function remapICS(text, offsetDays) {
    return text.replace(
      /(DTSTART|DTEND)((?:;TZID=[^:]+)?)(:)(\d{8})(T\d{6}Z?)?/g,
      (_, prop, tz, colon, dateStr, timePart) => {
        const shifted = addDays(parseD(dateStr), offsetDays);
        return `${prop}${tz}${colon}${fmtICS(shifted)}${timePart || ''}`;
      }
    );
  }

  generateBtn.addEventListener('click', () => {
    if (!icsText || !originalStart || !newDateEl.value) return;

    const ns   = getNewStart();
    const diff = Math.round((ns - originalStart) / 86400000);
    generatedICS = remapICS(icsText, diff);

    // Build data URI
    const encoded = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(generatedICS);
    const filename = `drawing_calendar_${fmtICS(ns)}.ics`;
    downloadLink.href = encoded;
    downloadLink.download = filename;

    outputBox.style.display = 'block';
    copyStatus.textContent = '';

    // Scroll into view
    setTimeout(() => outputBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
  });

  copyBtn.addEventListener('click', () => {
    if (!generatedICS) return;
    navigator.clipboard.writeText(generatedICS).then(() => {
      copyStatus.textContent = '✓  Copied to clipboard — paste into a text editor and save as calendar.ics';
    }).catch(() => {
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = generatedICS;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      copyStatus.textContent = '✓  Copied! Save as calendar.ics';
    });
  });
</script>
</body>
</html>
